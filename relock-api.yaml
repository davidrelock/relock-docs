openapi: 3.0.0
info:
  title: Relock API
  version: 1.0.0
  description: |
    The Relock API provides endpoints for device authentication and session management.
    Relock is an advanced software cryptographic authenticator that adds invisible strong
    factor authentication to your applications, providing continuous cryptographic trust
    without user friction.

    ## Authentication

    All Relock API endpoints require cryptographic proof generated by the Relock JavaScript
    agent. The agent provides:
    - **X-Key-Token**: A one-time token generated by the Relock agent
    - **X-Key-Signature**: A cryptographic signature proving device ownership
    - **X-Key-Session**: Session identifier from the X-Key-Session cookie

    These credentials are generated client-side using `window.relock.token()` and
    `window.relock.sign()` methods provided by the Relock JavaScript agent.

    ## Gateway Integration

    These endpoints are typically accessed through a reverse proxy that routes `/relock/*`
    requests to the Relock gateway. Ensure your reverse proxy is configured correctly
    and that the `X-Key-Wildcard` header is set with your gateway UUID.

  contact:
    name: Relock Support
    email: hi@relock.security
    url: https://relock.security
  license:
    name: Proprietary
servers:
  - url: /relock
    description: Relock Gateway (via reverse proxy)
tags:
  - name: Authentication
    description: User authentication and session management endpoints
paths:
  /login:
    post:
      tags:
        - Authentication
      summary: Sign user into Relock gateway
      description: |
        Associates a user identity with the current device in the Relock gateway.
        This enables automatic device recognition and reduces authentication friction
        for future sessions.

        **When to use:**
        - Call immediately after user successfully authenticates with your identity provider
        - Required for SameSite Integration and JavaScript Agent Integration deployments
        - Enables secure "remember me" functionality with cryptographic proof

        **Best Practices:**
        - Always call after identity provider authentication is confirmed
        - Handle errors gracefully - gateway login failure shouldn't block user access
        - Use backend implementation for better privacy compliance (GDPR, CCPA)
      operationId: relockLogin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            examples:
              frontend:
                summary: Frontend implementation example
                value:
                  X-Key-Token: "abc123def456..."
                  X-Key-Signature: "signature123..."
                  X-Key-Session: "session-id-from-cookie"
                  user: "user-123"
                  email: "user@example.com"
              backend:
                summary: Backend implementation example
                value:
                  X-Key-Token: "token-from-frontend"
                  X-Key-Signature: "signature-from-frontend"
                  X-Key-Session: "session-id-from-cookie"
                  user: "user-123"
                  email: "user@example.com"
      responses:
        '200':
          description: Login successful. User is now associated with the device.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              example:
                status_code: 200
                message: "Login successful"
        '401':
          description: Unauthorized. Missing or invalid token/signature.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status_code: 401
                message: "Invalid or missing authentication credentials"
        '404':
          description: Not Found. Device or session not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status_code: 404
                message: "Session not found"
        '409':
          description: Conflict. Token version mismatch - key rotation in progress.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status_code: 409
                message: "Token version mismatch. Please retry after key rotation."
        '417':
          description: Expectation Failed. Invalid signature.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status_code: 417
                message: "Invalid signature"
        '500':
          description: Internal Server Error. Gateway error.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status_code: 500
                message: "Internal server error"
  /logout:
    post:
      tags:
        - Authentication
      summary: Sign user out of Relock gateway
      description: |
        Terminates the device association in the Relock gateway. This should be called
        when users explicitly sign out of your application.

        **When to use:**
        - Call when user explicitly logs out of your application
        - Helps maintain accurate device ownership records
        - Prevents stale device associations

        **Best Practices:**
        - Call logout synchronously with your application logout
        - Handle errors gracefully - logout failure shouldn't block user sign-out
        - Consider calling logout even if login wasn't successful (idempotent operation)
      operationId: relockLogout
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LogoutRequest'
            example:
              X-Key-Token: "abc123def456..."
              X-Key-Signature: "signature123..."
              X-Key-Session: "session-id-from-cookie"
      responses:
        '200':
          description: Logout successful. Device association terminated.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              example:
                status_code: 200
                message: "Logout successful"
        '401':
          description: Unauthorized. Missing or invalid token/signature.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status_code: 401
                message: "Invalid or missing authentication credentials"
        '404':
          description: Not Found. Session not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status_code: 404
                message: "Session not found"
        '500':
          description: Internal Server Error. Gateway error.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status_code: 500
                message: "Internal server error"
  /confirm:
    post:
      tags:
        - Authentication
      summary: Confirm device authentication
      description: |
        Confirms and validates device authentication status. This endpoint can be used
        to verify that a device is properly authenticated and associated with a user
        session.

        **When to use:**
        - Verify device authentication status before sensitive operations
        - Check if device association is still valid
        - Validate session integrity

        **Best Practices:**
        - Handle confirmation failures appropriately based on your security requirements
      operationId: relockConfirm
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfirmRequest'
            example:
              X-Key-Token: "abc123def456..."
              X-Key-Signature: "signature123..."
              X-Key-Session: "session-id-from-cookie"
      responses:
        '200':
          description: Confirmation successful. Device is authenticated.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConfirmResponse'
              example:
                status_code: 200
                message: "Device authentication confirmed"
                authenticated: true
                device_id: "device-123"
        '401':
          description: Unauthorized. Device not authenticated or invalid credentials.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status_code: 401
                message: "Device not authenticated"
        '404':
          description: Not Found. Session not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status_code: 404
                message: "Session not found"
        '500':
          description: Internal Server Error. Gateway error.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status_code: 500
                message: "Internal server error"
components:
  schemas:
    LoginRequest:
      type: object
      required:
        - X-Key-Token
        - X-Key-Signature
        - X-Key-Session
        - user
        - email
      properties:
        X-Key-Token:
          type: string
          description: |
            One-time token generated by the Relock JavaScript agent using
            `window.relock.token()`. This token is hex-encoded.
          example: "abc123def456..."
        X-Key-Signature:
          type: string
          description: |
            Cryptographic signature generated by the Relock JavaScript agent using
            `window.relock.sign(token)`. This signature proves device ownership.
            This signature is hex-encoded.
          example: "signature123..."
        X-Key-Session:
          type: string
          description: |
            Session identifier obtained from the X-Key-Session cookie. This cookie
            is set by the Relock gateway and is required for session management.
          example: "session-id-from-cookie"
        user:
          type: string
          description: |
            User identifier from your identity provider. This should be the same
            identifier used in your application's authentication system.
          example: "user-123"
        email:
          type: string
          format: email
          description: |
            User's email address. Used for device association and user identification.
          example: "user@example.com"
    LogoutRequest:
      type: object
      required:
        - X-Key-Token
        - X-Key-Signature
        - X-Key-Session
      properties:
        X-Key-Token:
          type: string
          description: |
            One-time token generated by the Relock JavaScript agent using
            `window.relock.token()`. This token is hex-encoded.
          example: "abc123def456..."
        X-Key-Signature:
          type: string
          description: |
            Cryptographic signature generated by the Relock JavaScript agent using
            `window.relock.sign(token)`. This signature proves device ownership.
            This signature is hex-encoded.
          example: "signature123..."
        X-Key-Session:
          type: string
          description: |
            Session identifier obtained from the X-Key-Session cookie. This cookie
            is set by the Relock gateway and is required for session management.
          example: "session-id-from-cookie"
    ConfirmRequest:
      type: object
      required:
        - X-Key-Token
        - X-Key-Signature
        - X-Key-Session
      properties:
        X-Key-Token:
          type: string
          description: |
            One-time token generated by the Relock JavaScript agent using
            `window.relock.token()`. This token is hex-encoded.
          example: "abc123def456..."
        X-Key-Signature:
          type: string
          description: |
            Cryptographic signature generated by the Relock JavaScript agent using
            `window.relock.sign(token)`. This signature proves device ownership.
            This signature is hex-encoded.
          example: "signature123..."
        X-Key-Session:
          type: string
          description: |
            Session identifier obtained from the X-Key-Session cookie. This cookie
            is set by the Relock gateway and is required for session management.
          example: "session-id-from-cookie"
    SuccessResponse:
      type: object
      properties:
        status_code:
          type: integer
          description: HTTP status code
          example: 200
        message:
          type: string
          description: Success message
          example: "Operation successful"
    ErrorResponse:
      type: object
      properties:
        status_code:
          type: integer
          description: HTTP status code
          example: 401
        message:
          type: string
          description: Error message describing what went wrong
          example: "Invalid or missing authentication credentials"
    ConfirmResponse:
      type: object
      properties:
        status_code:
          type: integer
          description: HTTP status code
          example: 200
        message:
          type: string
          description: Confirmation message
          example: "Device authentication confirmed"
        authenticated:
          type: boolean
          description: Whether the device is authenticated
          example: true
        device_id:
          type: string
          description: Device identifier
          example: "device-123"

